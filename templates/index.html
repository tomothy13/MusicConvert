<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MusicConvert — Local UI</title>
  <style>
    body{font-family:system-ui, -apple-system, sans-serif; margin:20px}
    textarea{width:100%;height:120px}
    #log{white-space:pre-wrap;background:#111;color:#eee;padding:10px;height:240px;overflow:auto}
    button{padding:8px 12px;margin-top:8px}
  </style>
</head>
<body>
  <h2>MusicConvert — Local UI</h2>
  <p>Paste one or more links (comma or newline separated), then click <em>Start</em>.</p>
  <form id="form">
    <textarea name="links" id="links" placeholder="https://youtube.com/...\nhttps://youtube.com/playlist?list=..."></textarea>
    <br>
    <button type="submit">Start</button>
  </form>
  <h3>Job log</h3>
  <div id="log">Idle.</div>
  <div id="download" style="margin-top:8px"></div>
  <h3 style="margin-top:18px">Albums</h3>
  <div>
    <button id="refreshAlbums">Refresh Albums</button>
    <div id="albums" style="margin-top:8px"></div>
  </div>

<script>
const form = document.getElementById('form');
const log = document.getElementById('log');
const download = document.getElementById('download');

function append(msg){
  log.textContent += '\n' + msg;
  log.scrollTop = log.scrollHeight;
}

form.addEventListener('submit', async (ev) =>{
  ev.preventDefault();
  log.textContent = '';
  download.innerHTML = '';
  const data = new FormData(form);
  const res = await fetch('/enqueue', { method:'POST', body: data });
  const json = await res.json();
  if(json.job_id){
    const jid = json.job_id;
    append('Job started: ' + jid);
    const ws = new WebSocket(`ws://${location.host}/ws/${jid}`);
    ws.onmessage = (ev) => {
      const txt = ev.data;
      if(txt === 'ZIP_CREATED') append('ZIP created on server');
      else if(txt.startsWith('ZIP_READY:')){
        const name = txt.split(':',2)[1];
        download.innerHTML = `<a href="/download/${jid}">Download ${name}</a>`;
      } else if(txt === '__DONE__'){
        append('Job complete');
        ws.close();
      } else {
        append(txt);
      }
    };
    ws.onerror = (e)=> append('WebSocket error');
    ws.onclose = ()=> append('WS closed');
  } else {
    append('Failed to start job');
  }
});

  // Albums UI
  document.getElementById('refreshAlbums').addEventListener('click', async ()=>{
    const out = document.getElementById('albums');
    out.textContent = 'Loading...';
    const res = await fetch('/api/albums');
    const json = await res.json();
    out.innerHTML = '';
    if(json.albums && json.albums.length){
      json.albums.forEach(a => {
        const div = document.createElement('div');
        div.innerHTML = `<strong>${a.name}</strong> <a href="#" data-id="${a.id}" class="view">View</a> <a href="/download/album/${a.id}">Download ZIP</a>`;
        out.appendChild(div);
      });
      // attach click handlers
      out.querySelectorAll('.view').forEach(el => el.addEventListener('click', async (ev)=>{
        ev.preventDefault();
        const id = ev.target.getAttribute('data-id');
        const res = await fetch('/api/albums/' + id);
        const album = await res.json();
        const details = document.createElement('div');
        details.innerHTML = `<h4>${album.name}</h4>`;
        const list = document.createElement('ul');
        album.songs.forEach(s => {
          const li = document.createElement('li');
          const title = s.title || s.filename;
          li.innerHTML = `${title} - <a href="/download/song/${s.id}">Download</a>`;
          list.appendChild(li);
        });
        // replace albums div with details temporarily
        out.innerHTML = '';
        out.appendChild(details);
        out.appendChild(list);
        const back = document.createElement('div');
        back.innerHTML = '<a href="#" id="backToAlbums">Back to albums</a>';
        out.appendChild(back);
        document.getElementById('backToAlbums').addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('refreshAlbums').click(); });
      }));
    } else {
      out.textContent = 'No albums found.';
    }
  });
</script>
</body>
</html>
